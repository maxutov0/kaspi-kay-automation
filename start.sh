#!/bin/bash

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
set -e

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
log "üõ†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
export DISPLAY=:1
export QT_QPA_PLATFORM=offscreen
export PATH=$PATH:/opt/android-sdk/platform-tools  # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ adb –≤ PATH
log "‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã."

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫
log "üõ†Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫..."
sudo apt-get update
sudo apt-get install -y libxcb-cursor0 libxcb-xinerama0 libxcb-icccm4 libxcb-keysyms1 libxcb-image0 libxcb-render-util0 libxcb-xkb1 libxkbcommon-x11-0
log "‚úÖ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã."

# –ü—Ä–æ–≤–µ—Ä–∫–∞, –∑–∞–ø—É—â–µ–Ω –ª–∏ —É–∂–µ —ç–º—É–ª—è—Ç–æ—Ä
if pgrep -f "emulator" > /dev/null; then
    log "‚ùå –≠–º—É–ª—è—Ç–æ—Ä —É–∂–µ –∑–∞–ø—É—â–µ–Ω. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω—ã–º –∑–∞–ø—É—Å–∫–æ–º."
    exit 1
fi

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ VNC-—Å–µ—Ä–≤–µ—Ä–∞, –µ—Å–ª–∏ –æ–Ω —É–∂–µ –∑–∞–ø—É—â–µ–Ω
log "üõ†Ô∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ VNC-—Å–µ—Ä–≤–µ—Ä–∞, –µ—Å–ª–∏ –æ–Ω —É–∂–µ –∑–∞–ø—É—â–µ–Ω..."
vncserver -kill :1 > /dev/null 2>&1 || true
log "‚úÖ VNC-—Å–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ –ø–æ—Ä—Ç–∞ 6080
if lsof -i :6080 > /dev/null; then
    log "‚ùå –ü–æ—Ä—Ç 6080 —É–∂–µ –∑–∞–Ω—è—Ç. –û—Å–≤–æ–±–æ–¥–∏—Ç–µ –ø–æ—Ä—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
    exit 1
fi

# –ó–∞–ø—É—Å–∫ VNC-—Å–µ—Ä–≤–µ—Ä–∞
log "üõ†Ô∏è –ó–∞–ø—É—Å–∫ VNC-—Å–µ—Ä–≤–µ—Ä–∞..."
vncserver :1 -geometry 1280x800 -depth 24
log "‚úÖ VNC-—Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω."

# –ó–∞–ø—É—Å–∫ noVNC
log "üõ†Ô∏è –ó–∞–ø—É—Å–∫ noVNC..."
/opt/noVNC/utils/novnc_proxy --vnc localhost:5901 --listen 0.0.0.0:6080 &
NOVNC_PID=$!
log "‚úÖ noVNC –∑–∞–ø—É—â–µ–Ω (PID: $NOVNC_PID)."

# –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–Ω–µ—à–Ω–µ–≥–æ IP-–∞–¥—Ä–µ—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞
log "üõ†Ô∏è –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–Ω–µ—à–Ω–µ–≥–æ IP-–∞–¥—Ä–µ—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞..."
PUBLIC_IP=$(curl -s ifconfig.me)
if [ -z "$PUBLIC_IP" ]; then
    log "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–Ω–µ—à–Ω–∏–π IP-–∞–¥—Ä–µ—Å."
    exit 1
else
    log "‚úÖ –í–Ω–µ—à–Ω–∏–π IP-–∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞: $PUBLIC_IP"
fi

# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
log "üéâ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ VNC —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä:"
echo "1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: http://$PUBLIC_IP:6080/vnc.html"
echo "2. –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å: password"
echo "3. –ù–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å —É–¥–∞–ª—ë–Ω–Ω—ã–º –¥–æ—Å—Ç—É–ø–æ–º!"

# –ó–∞–ø—É—Å–∫ Android-—ç–º—É–ª—è—Ç–æ—Ä–∞
log "üõ†Ô∏è –ó–∞–ø—É—Å–∫ Android-—ç–º—É–ª—è—Ç–æ—Ä–∞..."
/opt/android-sdk/emulator/emulator -avd "pixel_7" -no-audio -no-boot-anim -gpu swiftshader_indirect -read-only -no-metrics &
EMULATOR_PID=$!
log "‚úÖ Android-—ç–º—É–ª—è—Ç–æ—Ä –∑–∞–ø—É—â–µ–Ω (PID: $EMULATOR_PID)."

# –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ —ç–º—É–ª—è—Ç–æ—Ä–∞
log "üõ†Ô∏è –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ —ç–º—É–ª—è—Ç–æ—Ä–∞..."
sleep 180  # –£–≤–µ–ª–∏—á–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –¥–æ 180 —Å–µ–∫—É–Ω–¥
log "‚úÖ –≠–º—É–ª—è—Ç–æ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é."

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ adb
log "üõ†Ô∏è –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ adb..."
adb kill-server
adb start-server
log "‚úÖ adb –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —ç–º—É–ª—è—Ç–æ—Ä–∞ —á–µ—Ä–µ–∑ adb
log "üõ†Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —ç–º—É–ª—è—Ç–æ—Ä–∞ —á–µ—Ä–µ–∑ adb..."
adb devices | grep "emulator" || {
    log "‚ùå –≠–º—É–ª—è—Ç–æ—Ä –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ adb. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —ç–º—É–ª—è—Ç–æ—Ä–∞."
    exit 1
}
log "‚úÖ –≠–º—É–ª—è—Ç–æ—Ä –æ–±–Ω–∞—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ adb."

# –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã
wait $EMULATOR_PID